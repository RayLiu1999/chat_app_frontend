#!/bin/sh

echo "ğŸ” Running Gemini AI code review..."

# å»ºç«‹ code_reviews è³‡æ–™å¤¾ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
mkdir -p code_reviews

# ç”¢ç”Ÿæ™‚é–“æˆ³è¨˜æª”å
timestamp=$(date "+%Y%m%d_%H%M%S")
review_file="code_reviews/review_${timestamp}.md"

# æ”¶é›†æ‰€æœ‰æš«å­˜çš„ TypeScriptã€Vue å’Œ JavaScript æª”æ¡ˆ
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|vue|js|tsx|jsx)$')

if [ -z "$staged_files" ]; then
    echo "â„¹ï¸ No code files to review"
    exit 0
fi

echo "ğŸ“‹ Files to review:"
echo "$staged_files"

# ç°¡åŒ–çš„å¯©æŸ¥æç¤º
review_prompt="è«‹ç”¨ç¹é«”ä¸­æ–‡ç°¡çŸ­å¯©æŸ¥ä»¥ä¸‹ Vue.js å°ˆæ¡ˆçš„ä»£ç¢¼è®Šæ›´ï¼Œé‡é»é—œæ³¨ï¼š
1. é‡è¦çš„ bug æˆ–é‚è¼¯éŒ¯èª¤
2. TypeScript é¡å‹å®‰å…¨å•é¡Œ
3. æ˜é¡¯çš„æ€§èƒ½æˆ–å®‰å…¨å•é¡Œ

è®Šæ›´æª”æ¡ˆï¼š
$staged_files

è«‹çµ¦å‡º 1-3 å€‹æœ€é‡è¦çš„å»ºè­°å³å¯ã€‚"

echo "ğŸ¤– Analyzing with Gemini AI..."

# ä½¿ç”¨ Gemini CLI
review_result=$(echo "$review_prompt" | gemini 2>&1)
exit_code=$?

if [ $exit_code -ne 0 ]; then
    echo "âŒ Gemini review failed. Continue anyway? (y/N)"
    read -r response
    if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
        exit 1
    fi
else
    # ä¿å­˜ review çµæœåˆ°æª”æ¡ˆ
    {
        echo "# Code Review Report"
        echo "**æ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "**åˆ†æ”¯**: $(git branch --show-current)"
        echo ""
        echo "## è®Šæ›´æª”æ¡ˆ"
        echo "\`\`\`"
        echo "$staged_files"
        echo "\`\`\`"
        echo ""
        echo "## AI å¯©æŸ¥çµæœ"
        echo "$review_result"
        echo ""
        echo "---"
        echo "*æ­¤å ±å‘Šç”± Gemini AI è‡ªå‹•ç”Ÿæˆ*"
    } > "$review_file"
    
    echo "âœ… Review Result:"
    echo "$review_result" | head -20  # é™åˆ¶è¼¸å‡ºè¡Œæ•¸
    echo ""
    echo "ğŸ“ Review saved to: $review_file"
    echo ""
fi

echo "âœ… Commit approved"
