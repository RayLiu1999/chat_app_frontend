#!/bin/sh

echo "ğŸ” Running Gemini AI code review (é›™é‡å¯©æŸ¥æ¨¡å¼)..."

# å»ºç«‹ code_reviews è³‡æ–™å¤¾ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
mkdir -p code_reviews

# ç”¢ç”Ÿæ™‚é–“æˆ³è¨˜æª”å
timestamp=$(date "+%Y%m%d_%H%M%S")
review_file1="code_reviews/review_${timestamp}_v1.md"
review_file2="code_reviews/review_${timestamp}_v2.md"

# æ”¶é›†æ‰€æœ‰æš«å­˜çš„ TypeScriptã€Vue å’Œ JavaScript æª”æ¡ˆ
# ä½¿ç”¨æ›´å®‰å…¨çš„å‘½ä»¤ï¼Œé¿å… grep å¤±æ•—æ™‚çš„å•é¡Œ
staged_files=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null | grep -E '\.(ts|vue|js|tsx|jsx)$' 2>/dev/null || true)

# æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆéœ€è¦å¯©æŸ¥
if [ -z "$staged_files" ] || [ "$staged_files" = "" ]; then
    echo "â„¹ï¸ No code files to review"
    exit 0
fi

echo "ğŸ“‹ Files to review:"
echo "$staged_files"

# ç¬¬ä¸€å€‹å¯©æŸ¥æç¤ºï¼ˆé‡é»é—œæ³¨é‚è¼¯å’Œé¡å‹å®‰å…¨ï¼‰
review_prompt1="è«‹ç”¨ç¹é«”ä¸­æ–‡å¯©æŸ¥ä»¥ä¸‹ Vue.js å°ˆæ¡ˆçš„ä»£ç¢¼è®Šæ›´ï¼Œä¸¦ä¸”å¹«æˆ‘åˆ†é‡è¦ç¨‹åº¦ç­‰ç´š(1-5)ï¼Œå…§å®¹é‡é»é—œæ³¨ï¼š
1. é‡è¦çš„ bug æˆ–é‚è¼¯éŒ¯èª¤
2. TypeScript é¡å‹å®‰å…¨å•é¡Œ
3. ä»£ç¢¼çµæ§‹å’Œæ¶æ§‹å•é¡Œ

è®Šæ›´æª”æ¡ˆï¼š
$staged_files

è«‹çµ¦å‡ºå…·é«”çš„æ”¹é€²å»ºè­°ã€‚"

# ç¬¬äºŒå€‹å¯©æŸ¥æç¤ºï¼ˆé‡é»é—œæ³¨æ€§èƒ½å’Œå®‰å…¨ï¼‰
review_prompt2="è«‹ç”¨ç¹é«”ä¸­æ–‡å¯©æŸ¥ä»¥ä¸‹ Vue.js å°ˆæ¡ˆçš„ä»£ç¢¼è®Šæ›´ï¼Œä¸¦ä¸”å¹«æˆ‘åˆ†é‡è¦ç¨‹åº¦ç­‰ç´š(1-5)ï¼Œå…§å®¹é‡é»é—œæ³¨ï¼š
1. æ˜é¡¯çš„æ€§èƒ½å•é¡Œ
2. å®‰å…¨æ¼æ´æˆ–é¢¨éšª
3. æœ€ä½³å¯¦è¸å’Œä»£ç¢¼å“è³ª

è®Šæ›´æª”æ¡ˆï¼š
$staged_files

è«‹çµ¦å‡ºå…·é«”çš„æ”¹é€²å»ºè­°ã€‚"

echo "ğŸ¤– Analyzing with Gemini AI (Review 1/2)..."

# ç¬¬ä¸€ä»½ review
review_result1=$(echo "$review_prompt1" | gemini 2>&1)
exit_code1=$?

echo "ğŸ¤– Analyzing with Gemini AI (Review 2/2)..."

# ç¬¬äºŒä»½ review
review_result2=$(echo "$review_prompt2" | gemini 2>&1)
exit_code2=$?

if [ $exit_code1 -ne 0 ] && [ $exit_code2 -ne 0 ]; then
    echo "âŒ Both Gemini reviews failed. Continue anyway? (y/N)"
    read -r response
    if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
        exit 1
    fi
else
    # ä¿å­˜ç¬¬ä¸€ä»½ review çµæœåˆ°æª”æ¡ˆ
    {
        echo "# Code Review Report (ç‰ˆæœ¬ 1 - é‚è¼¯èˆ‡é¡å‹)"
        echo "**æ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "**åˆ†æ”¯**: $(git branch --show-current 2>/dev/null || git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'unknown')"
        echo ""
        echo "## è®Šæ›´æª”æ¡ˆ"
        echo "\`\`\`"
        echo "$staged_files"
        echo "\`\`\`"
        echo ""
        echo "## AI å¯©æŸ¥çµæœ"
        echo "$review_result1"
        echo ""
        echo "---"
        echo "*æ­¤å ±å‘Šç”± Gemini AI è‡ªå‹•ç”Ÿæˆ (ç‰ˆæœ¬ 1)*"
    } > "$review_file1"

    # ä¿å­˜ç¬¬äºŒä»½ review çµæœåˆ°æª”æ¡ˆ
    {
        echo "# Code Review Report (ç‰ˆæœ¬ 2 - æ€§èƒ½èˆ‡å®‰å…¨)"
        echo "**æ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "**åˆ†æ”¯**: $(git branch --show-current 2>/dev/null || git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'unknown')"
        echo ""
        echo "## è®Šæ›´æª”æ¡ˆ"
        echo "\`\`\`"
        echo "$staged_files"
        echo "\`\`\`"
        echo ""
        echo "## AI å¯©æŸ¥çµæœ"
        echo "$review_result2"
        echo ""
        echo "---"
        echo "*æ­¤å ±å‘Šç”± Gemini AI è‡ªå‹•ç”Ÿæˆ (ç‰ˆæœ¬ 2)*"
    } > "$review_file2"

    echo "âœ… Review Results:"
    echo ""
    echo "ğŸ“‹ Review 1 (é‚è¼¯èˆ‡é¡å‹):"
    echo "$review_result1" | head -10
    echo ""
    echo "ğŸ“‹ Review 2 (æ€§èƒ½èˆ‡å®‰å…¨):"
    echo "$review_result2" | head -10
    echo ""
    echo "ğŸ“ Reviews saved to:"
    echo "   - $review_file1"
    echo "   - $review_file2"
    echo ""
fi

echo "âœ… Commit approved"
exit 0
